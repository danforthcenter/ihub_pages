# Name of your workflow, visible in the GitHub Actions tab
name: Build Hugo Site and Create Tarball

# Controls when the workflow will run
on:
  # Trigger the workflow on pushes to the 'main' branch
  push:
    branches:
      - main
  # Allow manual triggering from the GitHub Actions tab
  workflow_dispatch:

# Define the jobs to run in this workflow
jobs:
  build_and_archive:
    # The runner environment for this job
    runs-on: ubuntu-latest

    # Steps define the sequence of tasks for this job
    steps:
      # Step 1: Checkout the repository code
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch all history for .GitInfo and .Lastmod in Hugo
          fetch-depth: 0
          # Include submodules if your Hugo theme is a submodule
          submodules: true

      # Step 2: Set up Go environment (needed for Hugo modules)
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      # Step 3: Set up Hugo environment
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      # Step 4: Initialize and download Hugo modules
      - name: Initialize Hugo modules
        run: |
          # Initialize Hugo modules if go.mod doesn't exist
          if [ ! -f go.mod ]; then
            hugo mod init github.com/${{ github.repository }}
          fi
          # Download/update Hugo modules
          hugo mod get -u
          hugo mod tidy

      # Step 5: Build the Hugo site
      - name: Build Hugo site
        run: |
          # Ensure the public directory is clean before building
          rm -rf public
          # Build the site into the 'public' directory
          hugo --minify --gc --verbose

      # Step 6: List contents to debug
      - name: Debug - List public directory contents
        run: |
          echo "Contents of public directory:"
          find public -type f -name "*.css" -o -name "*.js" | head -20
          echo "Total files in public:"
          find public -type f | wc -l

      # Step 7: Create a tarball of the static assets
      - name: Create tarball of static assets
        run: |
          # Define the output file name for the tarball
          TARBALL_NAME="hugo-site-$(date +%Y%m%d-%H%M%S)-${{ github.sha }}.tar.gz"
          tar -czvf $TARBALL_NAME public/
          echo "Tarball created: $TARBALL_NAME"
          echo "TARBALL_NAME=$TARBALL_NAME" >> "$GITHUB_ENV"

      # Step 8: Upload the tarball as a workflow artifact
      - name: Upload static site tarball
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.TARBALL_NAME }}
          path: ${{ env.TARBALL_NAME }}
          retention-days: 7

  # Deploy to GitHub Pages
  deploy_to_gh_pages:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build_and_archive
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      # Set up Go environment for Hugo modules
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      # Initialize and download Hugo modules
      - name: Initialize Hugo modules
        run: |
          if [ ! -f go.mod ]; then
            hugo mod init github.com/${{ github.repository }}
          fi
          hugo mod get -u
          hugo mod tidy

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4

      # Build specifically for GitHub Pages
      - name: Build Hugo site for GitHub Pages
        run: |
          rm -rf public
          # Build with the GitHub Pages URL
          hugo --minify --gc --baseURL "${{ steps.pages.outputs.base_url }}"

      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: './public'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
